# Periphery-Reader
To scan the inner surface of a room or cavity.
**This project is far from done**

## The Arduino
The Arduino is what collects the data and collects data on each point where the survey occured. It has two modes, **Survey Station** and **Data Collect**.
### Survey Station
This mode is initalized by pushing B on the keypad. Once the button is pushed a buzzer beeps, as which occurs every time a button is pushed and an action follows. If nothing is set to occur and a button is pushed no beep will be heard. The Arduino then requests that it is given a name for the station, the general format is A-(0-9). Your first station should be A-0 with each station progressively increasing by 1 for the numeric value. The values needed to calculate the station positions include the azumith to the next station, the amount of degrees from horizontal to the next station, as well as the distance to the next station. All of these except the distance are automatically ditermined therefore at this step the distance is requested from the user. This is a 3 digit input where the decimal counts as a digit, so if the distance is 5 feet the input must be 5.0 and if the distance if 0.5 feet the input must be 0.5. After this the Arduino must not be moved as to not disturb the next step of the process as it gets its azumith and vertical inclination. This is done using a very bad **QMC-5883** which is not very accurate and needs to be improved, so it takes 150 readings of both the azumith and verical inclination. A operating animation plays during these readings. The values are later rounded by the host computer.
### Data Collect
The data collect mode of operation is activated by pushing A on the keypad at any time however if done prior to a survey station operation the data will have nowhere to go. If the data collect feature is activated immediately after a previous data collection all of the data collected will be transferred to the most recent survey station, however the data will not be presented in a usable format. When data collection is activated a 3 second countdown displays on the **7 segment display** at the end of the countdown the **stepper motor** steps 512 steps clockwise achiving a 1/4 of a full revolution putting the **ultrasonic sensor** in place to get the distance to the nearest surface horizontal to the Arduino. It then beeps and collects a data point for the distance between it and the surface detected. The **stepper motor** then does 64 steps in the counter clockwise direction, which is equal to 1/34th of a full rotation. It then repeats this 16 more times, collecting a total of 17 points in a hemisphere above the Arduino. It then turns 1024 steps in the clockwise directon, and then turns 512 steps in the counterclockwise direction to properly center itself for another reading at a new survey station. Then the temperature and humitity are recorded incase that is of any use for the application in which the device is used.
## The Host (Raspberry Pi)
The host, which can be any linux machine, performs multiple operations including 2 main operations which are **Data Receive** and **3D Plot Data**. Both programs need to be manually started 
### Data Receive
The data receive program must run prior to running any program on the Arduino, but after the Arduino is attached to the host via a USB connection. This program operates by initally attempting to establish a serial connection on **/dev/ttyACM0**. If it is unable to establish a connection it prints "No microcontroller found." to the shell. Once a connection is established the program waits for input. While most of the data such as temperature, humidity, and the readings from the **ultrasonic sensor** are just transferred into a csv file which all of the data read is eventually transferred into, the **QMC-5883**'s goes through a different process. Since 150 gyroscopic readings are taken they must be averaged to make the data more manageable. This is done for both the azumith and verical inclination.
The final format of the data is as shown:

|Angle From North|Angle From Horiz.|Distance| | | | | | | | | | | | | | |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|90.2328|-14.547417|0.6|
|Map|
|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|
|Temperature|Humidity|
|21|40|
### 3D Plot Data
This program must be done after all wanted data has been put into csv files by the **Data Receive** program. This program works by opening each csv file one at a time. It recognizes data which has a title of A-(0-11) with each increasing number being the data from the next survey station in sequence. For each file it gets the coordinates of the datapoints by performing the following operations. First it opens the file and extracts only the needed data to find out where the point in space that the data was collected from. With this extracted information it then finds the x value for the station by multiplying the displacement from the previous station and multiplying it by the cosine of the azumith in radians, this value is then added to the previous stations position, as the displacement is from the previous survey position and not the origin. The z value of the station is then obtained by multiplying the displacement by the sin of the azumith converted to radians added to the previous zstation value for the same reason as the xstation's new value. This information is then moved into a new csv file where the columns and rows are swapped for ease of use. Further conversions are then done to those values, and then the previous csv file is opened a second time, however this time it is to get the y value of the survey station. This is done by multiplying the displacement from the previous position by the sin value of the vertical inclination in radians, which is then added to the previous y station. This is then moved to another csv file and the rows and columns are swapped for ease of access. Now that the position of the survey stations are known, all the files created for math and data transfer are deleted. Now the data from the **ultrasonic sensor** is ready to be converted to coordinates. For each value collected by the **ultrasonic sensor** a x and y value must be created. For the x values this can be done by multiplying the distance by cos of the number of the datapoint (1-17) divided by the total number of datapoints multiplied by pi. This can be omitted by point number nine, as its displacement relative to the survey station in the x axis is 0, these values are then put into list form. For the y values, the same procedure is used except using sin and not cosine. In this case the first and final datapoints can be ommitted as they are perfectly level with the survey station at this step. Now not all readings are facing perfectly north therefore all of these datapoints have to be able to be rotated around a point which in this case is the survey station. However since the Arduino is not programmed to collect data if it is turned in any other direction than from north we can assume that all the readings were taken from a level plane, therefore only x and z values need to be calculated. for the x values, this is done by independently taking each value and multiplying it by the cos of the azumith, plus 90 degrees (as north is not along the x axis initally), in radians. Then from this the sin of the azumith in radians is multiplied by the equivlant z value, which is always 0 in this case. However to get the new z values the same operation is performed but instead the sin and cos are swapped, this means we can omit the subtraction of the z value. All of the math to rotate the points can be omitted if the azumith is either 0 or 180 degrees. These values are still absolute to the point that they were obtained from, therefore they must be added to the position of the point they were obtained from. But since the first survey point is always at the origin, they must be added to the previous survey station coordinate. Since matplotlib is being used to graph the data for ideal graphing speeds all of the x, y, and z datapoints for every station must each be in their own list. This is done by extending an empty x, y, and z list by the x, y, and z values that were obtained prior, therefore by the end all of the points are in lists. A scatter plot of the data is then created and labels are added. Finally a wireframe is created. In order to prevent graphical errors the wireframe is created by putting through 16 points in a row, excluding the first point (which is always 0,0), seperating each line by the distance to the next point. Creating a line for each survey station. Then a line is put in between all of the like points, in order for this to be done, the line has to bridge to the equivlent point at the next survey station, which always ends up 16 data points further along. The plot is then shown.
## Notes For Better Results
- Keep survey stations in a straight line
- Dont have any surfaces less than 4 inches from the ultrasonic sensor
